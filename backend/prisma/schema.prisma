// Fortium Payouts - Database Schema
// Using Render PostgreSQL
//
// ⚠️  IMPORTANT: Before running `prisma db push` with schema changes:
//     1. Run: npm run db:backup-wise-recipients
//     2. Review the schema diff carefully
//     3. If data loss occurs, restore with: npm run db:restore-wise-recipients
//
// This project uses db push (not migrations). Schema changes can cause data loss!

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant represents a PartnerConnect tenant with 1:1 QBO company mapping
model Tenant {
  id                 String   @id @default(cuid())
  name               String   // "US" or "Canada"
  pcTenantId         String   @unique // PartnerConnect tenant ID
  qboCompanyId       String   // QuickBooks company ID
  paymentProcessor   String   // "bill_com" or "wise"
  provingPeriodHours Int      @default(24)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  payments PaymentRecord[]

  @@map("tenants")
}

// AdminUser for Google OAuth allowlist
model AdminUser {
  id          String    @id @default(cuid())
  email       String    @unique
  createdAt   DateTime  @default(now())
  lastLoginAt DateTime?

  @@map("admin_users")
}

// PaymentRecord tracks payment attempts and history
model PaymentRecord {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  pcBillId       String    // PartnerConnect bill ID
  qboInvoiceId   String    // QuickBooks invoice ID
  payeeVendorId  String    // Bill.com or Wise vendor ID
  payeeName      String    // Vendor/payee name for display
  amount         Decimal   @db.Decimal(12, 2)
  status         String    // pending_controls, ready, queued, processing, paid, failed
  controlResults Json      // { invoicePaid: true, invoiceNotVoided: true, ... }
  failureReason  String?   // Reason if status is 'failed'
  paidAt         DateTime?
  paymentRef     String?   // External payment reference from Bill.com/Wise
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Bill.com payment execution tracking
  billComBillId  String?   // Bill.com bill ID (from their system)
  billComPaymentId String? // Bill.com SentPay ID
  processDate    String?   // Scheduled process date (YYYY-MM-DD)
  executedAt     DateTime? // When payment was submitted to Bill.com/Wise
  executedBy     String?   // User who triggered execution

  // Wise payment execution tracking
  wiseTransferId   Int?      // Wise transfer ID
  wiseQuoteId      String?   // Wise quote UUID
  wiseCurrency     String?   // Target currency (e.g., 'CAD')
  wiseExchangeRate Decimal?  @db.Decimal(12, 6) // Exchange rate used
  wiseTargetAmount Decimal?  @db.Decimal(12, 2) // Amount in target currency
  wiseFee          Decimal?  @db.Decimal(12, 2) // Wise fee

  // Email tracking (Phase 1: Wise payment confirmations)
  payeeEmail     String?   // Email address used for notification
  emailSentAt    DateTime? // Timestamp of successful send
  emailMessageId String?   // Postmark message ID
  emailStatus    String?   // 'sent', 'delivered', 'failed', 'bounced', 'skipped'
  emailError     String?   // Error message if failed

  @@index([tenantId])
  @@index([status])
  @@index([pcBillId])
  @@index([paymentRef])
  @@index([billComPaymentId])
  @@index([wiseTransferId])
  @@map("payment_records")
}

// ControlConfig stores adjustable control settings
model ControlConfig {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "proving_period_hours", "auto_pay_enabled"
  value     String   // JSON-encoded value
  updatedAt DateTime @updatedAt

  @@map("control_configs")
}

// WiseRecipient maps QBO vendor to Wise account (CA payments)
model WiseRecipient {
  id                     String   @id @default(cuid())
  qboVendorId            String   @unique // QBO vendor ID (from PC Resource.CAExternalUserId)
  payeeName              String            // Display name (for reference only)
  wiseEmail              String            // Wise account email (required for Wise-to-Wise transfers)
  targetCurrency         String   @default("CAD") // Target currency for payments
  wiseContactId          String?           // Contact UUID from Wise address book (for Wise-to-Wise)
  wiseRecipientAccountId Int?              // Cached v1/accounts ID (created from email recipient)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("wise_recipients")
}

// BillComVendor maps QBO vendor to Bill.com vendor (US payments)
model BillComVendor {
  id              String   @id @default(cuid())
  qboVendorId     String   @unique // QBO vendor ID (from PC Resource.USExternalUserId)
  payeeName       String            // Display name (for reference only)
  billComVendorId String            // Bill.com vendor ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("billcom_vendors")
}

// ValidationRule stores configurable validation rules for bill processing
model ValidationRule {
  id         String   @id @default(cuid())
  name       String   @unique
  ruleType   String   // required_field, amount_threshold, approval_required, custom, duplicate_detection
  conditions Json     // Rule-specific configuration (e.g., { field: "payeeName" } or { threshold: 10000 })
  active     Boolean  @default(true)
  priority   Int      @default(0) // Lower number = higher priority
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([active])
  @@index([priority])
  @@map("validation_rules")
}

// DismissedBill tracks bills manually dismissed from active queue (not payments)
model DismissedBill {
  id            String   @id @default(cuid())
  pcBillId      String   @unique
  reason        String
  dismissedBy   String
  dismissedAt   DateTime @default(now())
  payeeName     String
  clientName    String
  amount        Decimal  @db.Decimal(12, 2)
  tenantCode    String
  description   String?
  qboInvoiceNum String?
  qboBillNum    String?

  @@index([pcBillId])
  @@map("dismissed_bills")
}
